<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>DynamoDB Update Document</title>
<style>
body { font-family: sans-serif; margin: 20px; line-height: 1.6; background-color: #f4f4f4; color: #333; }
.container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
pre { background: #f0f0f0; padding: 1em; border-radius: 5px; overflow-x: auto; border: 1px solid #ddd; }
code { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 0.9em;}
h1, h2 { border-bottom: 1px solid #eee; padding-bottom: 0.3em;}
a.back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; }
a.back-link:hover { text-decoration: underline; }
</style>
</head>
<body>
<div class="container">
<a href="../index.html" class="back-link">&laquo; Back to Index</a>
<h1 id="dynamodb-update-document">DynamoDB Update Document</h1>

<h2 id="dynamodb-update-document-rb">DynamoDB Update Document.rb</h2>

<pre><code class="language-ruby">require &quot;aws-sdk&quot;
require &quot;thread&quot; # for Mutex

class DynamoTest
  attr_reader :table_name, :client
  
  def initialize
    @mutex      = Mutex.new
    @client     = AWS::DynamoDB::Client::V20120810.new
    @table_name = &quot;foo&quot;
    
    put_stuff
  end
  
  def put_stuff(ident, value) # value == &quot;my_content&quot;
    current_sequence = sequence_for(ident) # ident == &quot;my_primary_key&quot;
    
    @mutex.synchronize do
      client.put_item({
        :table_name =&gt; table_name,
        :item =&gt; {
          'key' =&gt; {
            'S' =&gt; ident
          },
          'value' =&gt; {
            'N' =&gt; value.to_s
          }
        },
        # The conditions of our &quot;put&quot; operation:
        # If the &quot;key&quot; isn't NULL (i.e. it exists) then our condition has failed
        # This means we only want to put the item if it doesn't already exist
        # Also, The &quot;value&quot; we're putting needs to be a numeric value greater than the current sequence value.
        :expected =&gt; {
          'key' =&gt; {
            :comparison_operator =&gt; 'NULL'
          },
          'value' =&gt; {
            :comparison_operator =&gt; 'GE',
            :attribute_value_list =&gt; [
              { 'N' =&gt; current_sequence.to_s }
            ]
          }
        },
        :conditional_operator =&gt; 'OR'
      })
    end
  end
  
  def sequence_for(ident)
    data = client.get_item(
      item_payload(ident)
    )

    data.length &gt; 0 ? data[:item][&quot;value&quot;][:n].to_i : 0
  end
  
  def item_payload(ident)
    {
      :table_name =&gt; table_name,
      :key =&gt; {
        'key' =&gt; {
          'S' =&gt; ident.to_s
        }
      }
    }
  end
end
</code></pre>

</div>
</body>
</html>