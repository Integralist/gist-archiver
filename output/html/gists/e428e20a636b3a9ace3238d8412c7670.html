<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>[Varnish VCL Basic Authentication] #security #basicauth #authentication #vcl #varnish #fastly #cdn</title>
<link rel="stylesheet" type="text/css" href="../../assets/css/styles.css">
</head>
<body>
<div class="container">
<a href="../index.html" class="back-link">&laquo; Back to Index</a>
<h1 id="varnish-vcl-basic-authentication-security-basicauth-authentication-vcl-varnish-fastly-cdn">[Varnish VCL Basic Authentication] #security #basicauth #authentication #vcl #varnish #fastly #cdn</h1>

<h2 id="varnish-vcl-basic-authentication-md">Varnish VCL Basic Authentication.md</h2>

<pre><code class="language-markdown">## generate a username/password

```bash
echo -n beep:boop | base64

YmVlcDpib29w
</code></pre>

<blockquote>
<p>Note: it&rsquo;s important to use <code>-n</code> otherwise <code>echo</code> will add a line break and that can be a time consuming error to debug when you find your username/password isn&rsquo;t working ;-) if you do find you need to debug, then use <code>curl</code> with the <code>-v</code> flag and inspect the request headers being sent and make sure your base64 encoded username/password matches what curl generates for the <code>Authorization</code> header when using the <code>--user</code> flag (see below curl examples)</p>
</blockquote>

<h2 id="vcl-code">vcl code</h2>

<pre><code class="language-vcl">sub vcl_recv {
  #FASTLY recv
  
  if (!req.http.Authorization ~ &quot;Basic YmVlcDpib29w&quot;) {
    error 401 &quot;Restricted&quot;;
  }

  return(lookup);
}

sub vcl_error {
  #FASTLY error
  
  if (obj.status == 401) {
    set obj.http.Content-Type = &quot;text/html; charset=utf-8&quot;;
    set obj.http.WWW-Authenticate = &quot;Basic realm=Secured&quot;;

    synthetic {&quot;
      &lt;!doctype html&gt;
      &lt;html&gt;
        &lt;head&gt;
          &lt;meta charset=&quot;utf-8&quot;&gt;
          &lt;title&gt;Error&lt;/title&gt;
        &lt;/head&gt;
        &lt;body&gt;
          &lt;h1&gt;401 Unauthorized (varnish)&lt;/h1&gt;
        &lt;/body&gt;
      &lt;/html&gt;
      &quot;};

    return (deliver);
  }
}
</code></pre>

<h2 id="example-curl-commands">example curl commands</h2>

<pre><code class="language-bash">curl --user beep:boop https://www.example.com/auth-me
curl -H &quot;Authorization: Basic YmVlcDpib29w&quot; https://www.example.com/auth-me
</code></pre>

<p>&rdquo;`</p>

</div>
</body>
</html>