<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>[Terraform Modules for structuring your resources] #terraform #modules #fastly</title>
<link rel="stylesheet" type="text/css" href="../../assets/css/styles.css">
</head>
<body>
<div class="container">
<a href="../index.html" class="back-link">&laquo; Back to Index</a>
<h1 id="terraform-modules-for-structuring-your-resources-terraform-modules-fastly">[Terraform Modules for structuring your resources] #terraform #modules #fastly</h1>

<h2 id="terraform-modules-for-structuring-your-resources-md">Terraform Modules for structuring your resources.md</h2>

<pre><code class="language-markdown"></code></pre>

<p>.
├── main.tf
├── modules
│   ├── compute.example.com
│   │   ├── main.tf
│   │   ├── package-built-locally-via-cli.tar.gz
│   │   └── provider.tf
│   └── www.example.com
│       ├── main.tf
│       ├── provider.tf
│       └── vcl
│           └── main.vcl
└── provider.tf</p>

<pre><code>
The `provider.tf` is the same file across the entire project, but we have to duplicate it as each module needs its own provider dependency graph (otherwise `terraform init` will fail).

IMPORTANT: if you use a 'known' provider (e.g. a hashicorp provider, like `hashicorp/aws`), then child modules don't need to define those dependencies in a `required_providers` block. But as `fastly/fastly` isn't a hashicorp provider (not any more it's not; it _used_ to be) it means we need a `provider.tf` in every child module. See https://www.terraform.io/docs/language/modules/develop/providers.html#implicit-provider-inheritance for details.

The `package-built-locally-via-cli.tar.gz` was something I generated using the [Fastly CLI](https://github.com/fastly/cli) with `fastly compute build`.

&gt; **NOTE**: the use of `path.module` is documented here https://www.terraform.io/docs/language/expressions/references.html#filesystem-and-workspace-info

If using more providers and with more complex structuring (e.g. you reuse your modules), then it’s strongly recommended you implement a &quot;[module composition](https://www.terraform.io/docs/language/modules/develop/composition.html)&quot; approach to using Terraform modules, as this allows for greater flexibility and code reuse.

HashiCorp also provides their own [guidelines](https://www.terraform.io/docs/language/modules/develop/index.html#when-to-write-a-module) on when to write a module.
</code></pre>

<h2 id="compute-main-tf">compute-main.tf</h2>

<pre><code class="language-hcl">resource &quot;fastly_service_compute&quot; &quot;service&quot; {
  name = &quot;Compute Service&quot;

  domain {
    name = &quot;compute.example.com&quot;
  }

  package {
    filename         = &quot;${path.module}/package-built-locally-via-cli.tar.gz&quot;
    source_code_hash = filesha512(&quot;${path.module}/package-built-locally-via-cli.tar.gz&quot;)
  }

  backend {
    address = &quot;httpbin.org&quot;
    name    = &quot;httpbin&quot;
  }

  force_destroy = true
}
</code></pre>

<h2 id="main-tf">main.tf</h2>

<pre><code class="language-hcl">module &quot;www&quot; {
  source = &quot;./modules/www.example.com&quot;
}

module &quot;compute&quot; {
  source = &quot;./modules/compute.example.com&quot;
}
</code></pre>

<h2 id="provider-tf">provider.tf</h2>

<pre><code class="language-hcl">terraform {
  required_providers {
    fastly = {
      source  = &quot;fastly/fastly&quot;
      version = &quot;0.27.0&quot;
    }
  }
}
</code></pre>

<h2 id="www-main-tf">www-main.tf</h2>

<pre><code class="language-hcl">resource &quot;fastly_service_v1&quot; &quot;service&quot; {
  name = &quot;Example Service&quot;

  domain {
    name = &quot;www.example.com&quot;
  }

  backend {
    address = &quot;httpbin.org&quot;
    name    = &quot;httpbin&quot;
  }

  vcl {
    content = file(&quot;${path.module}/vcl/main.vcl&quot;)
    main    = true
    name    = &quot;custom_vcl&quot;
  }

  force_destroy = true
}

</code></pre>

</div>
</body>
</html>