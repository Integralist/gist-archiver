<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>[Fastly Terraform Multiple Environments using Modules] #terraform #environments #hcl #fastly</title>
<link rel="stylesheet" type="text/css" href="../assets/css/styles.css">
</head>
<body>
<div class="container">
<a href="../index.html" class="back-link">&laquo; Back to Index</a>
<h1 id="fastly-terraform-multiple-environments-using-modules-terraform-environments-hcl-fastly">[Fastly Terraform Multiple Environments using Modules] #terraform #environments #hcl #fastly</h1>

<h2 id="1-readme-md">1. README.md</h2>

<pre><code class="language-markdown"># Terraform Environments using Modules

</code></pre>

<p>.
├── modules
│   ├── service-compute
│   │   ├── main.tf
│   │   ├── package-built-locally-via-cli.tar.gz
│   │   ├── provider.tf
│   │   └── variables.tf
│   └── service-vcl
│       ├── main.tf
│       ├── provider.tf
│       ├── variables.tf
│       └── vcl
│           └── main.vcl
├── prod
│   ├── inputs.tfvars
│   ├── main.tf
│   ├── provider.tf
│   └── variables.tf
└── stage</p>

<pre><code>├── inputs.tfvars
├── main.tf
├── provider.tf
└── variables.tf
</code></pre>

<pre><code>
Within each directory (`prod` and `stage`) run `terraform init`.

Then inside each directory run `terraform plan -var-file=&quot;inputs.tfvars&quot;`.

&gt; **NOTE**: I don't show the contents for every file as most are the same as others. For example, `provider.tf` is the same across all directories. The stage and prod directories are all the same with the exception of the `inputs.tfvars` (e.g. I use the default variable value in prod, where I provide my own value for the variable in stage) and the `variables.tf` (where I set different default values for each environment).
</code></pre>

<h2 id="4-modules-service-vcl-main-tf">4. modules - service-vcl - main.tf</h2>

<pre><code class="language-hcl">resource &quot;fastly_service_v1&quot; &quot;service&quot; {
  name = &quot;Example Service&quot;

  domain {
    name = &quot;${var.subdomain}.example.com&quot;
  }

  backend {
    address = &quot;httpbin.org&quot;
    name    = &quot;httpbin&quot;
  }

  vcl {
    content = file(&quot;${path.module}/vcl/main.vcl&quot;)
    main    = true
    name    = &quot;custom_vcl&quot;
  }

  force_destroy = true
}

</code></pre>

<h2 id="6-stage-main-tf">6. stage - main.tf</h2>

<pre><code class="language-hcl">module &quot;www&quot; {
  source    = &quot;../modules/service-vcl&quot;
  subdomain = var.subdomain
}

module &quot;compute&quot; {
  source    = &quot;../modules/service-compute&quot;
  subdomain = var.subdomain
}
</code></pre>

<h2 id="7-stage-provider-tf">7. stage - provider.tf</h2>

<pre><code class="language-hcl">terraform {
  required_providers {
    fastly = {
      source  = &quot;fastly/fastly&quot;
      version = &quot;0.27.0&quot;
    }
  }
}
</code></pre>

<h2 id="2-modules-service-compute-main-tf">2. modules - service-compute - main.tf</h2>

<pre><code class="language-hcl">resource &quot;fastly_service_compute&quot; &quot;service&quot; {
  name = &quot;Compute Service&quot;

  domain {
    name = &quot;${var.subdomain}-compute.example.com&quot;
  }

  package {
    filename         = &quot;${path.module}/package-built-locally-via-cli.tar.gz&quot;
    source_code_hash = filesha512(&quot;${path.module}/package-built-locally-via-cli.tar.gz&quot;)
  }

  backend {
    address = &quot;httpbin.org&quot;
    name    = &quot;httpbin&quot;
  }

  force_destroy = true
}
</code></pre>

<h2 id="3-modules-service-compute-service-vcl-variables-tf">3. modules - service-compute,service-vcl - variables.tf</h2>

<pre><code class="language-hcl">variable &quot;subdomain&quot; {
  type = string
}
</code></pre>

<h2 id="5-stage-inputs-tfvars">5. stage - inputs.tfvars</h2>

<pre><code class="language-hcl">subdomain = &quot;staging&quot;
</code></pre>

<h2 id="8-stage-variables-tf">8. stage - variables.tf</h2>

<pre><code class="language-hcl">variable &quot;subdomain&quot; {
  type    = string
  default = &quot;stage&quot;
}
</code></pre>

<h2 id="9-prod-variables-tf">9. prod - variables.tf</h2>

<pre><code class="language-hcl">variable &quot;subdomain&quot; {
  type    = string
  default = &quot;www&quot;
}
</code></pre>

</div>
</body>
</html>